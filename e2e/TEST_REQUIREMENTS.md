# E2Eテスト要件定義

## 1. セキュリティ機能のテスト要件

### 1.1 CSRF保護
- **目的**: クロスサイトリクエストフォージェリ攻撃からの保護を確認
- **検証項目**:
  - [ ] CSRFトークンなしでPOSTリクエストが拒否される
  - [ ] 有効なCSRFトークンでPOSTリクエストが成功する
  - [ ] トークンの有効期限が正しく動作する
  - [ ] 異なるセッション間でトークンが共有されない

### 1.2 認証・認可
- **目的**: ユーザー認証と権限管理が正しく動作することを確認
- **検証項目**:
  - [ ] 未認証ユーザーが保護ページにアクセスできない
  - [ ] ログイン後、適切な権限でアクセスできる
  - [ ] 管理者権限のユーザーのみ管理画面にアクセスできる
  - [ ] セッションタイムアウトが正しく動作する

### 1.3 レート制限
- **目的**: API乱用防止機能が動作することを確認
- **検証項目**:
  - [ ] 連続リクエストが制限される
  - [ ] 制限解除後に正常にアクセスできる
  - [ ] 異なるエンドポイントで独立した制限が動作する

## 2. テスト環境の要件

### 2.1 データベース
- **要件**: テスト用の独立したデータベース環境
- **必要なテーブル**:
  - auth.users (Supabase Auth)
  - public.profiles
  - public.security_events ← **現在欠落**
  - public.rate_limit_attempts
  - public.csrf_tokens

### 2.2 環境変数
- **本番同等モード**: セキュリティ機能全て有効
- **開発モード**: 部分的な緩和（レート制限のみ無効等）
- **デバッグモード**: 詳細ログ出力

## 3. テスト実装アプローチ

### 3.1 段階的テスト
1. **Phase 1**: 基本機能のみ（セキュリティ機能を段階的に無効化）
2. **Phase 2**: セキュリティ機能を1つずつ有効化してテスト
3. **Phase 3**: 全機能有効での統合テスト

### 3.2 モック vs 実環境
- **CSRFトークン**: 実際のトークン生成・検証を使用
- **データベース**: テスト用の実DBを使用（データは各テスト後にクリーンアップ）
- **外部API**: モック化（翻訳API等）

## 4. 現在の問題と解決策

### 問題1: security_eventsテーブルの欠落
**解決策**: マイグレーションファイルに追加
```sql
CREATE TABLE IF NOT EXISTS public.security_events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  event_type TEXT NOT NULL,
  severity TEXT NOT NULL,
  details JSONB,
  request_id TEXT,
  user_id UUID,
  ip_address TEXT,
  user_agent TEXT,
  path TEXT,
  method TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 問題2: E2E環境でのCSRF検証
**解決策**: 
- テスト専用のCSRFトークン管理
- Playwrightでのcookie/header管理の改善
- 実際のブラウザ動作をシミュレート

### 問題3: Role権限の不整合
**解決済み**: 大文字小文字の正規化実装

## 5. 推奨されるテストシナリオ

### シナリオ1: 管理者ログインと権限確認
```gherkin
Given 管理者アカウントが存在する
When 管理者としてログインする
Then ダッシュボードが表示される
And 管理画面へのリンクが表示される
When 管理画面にアクセスする
Then 管理機能が利用できる
```

### シナリオ2: CSRF保護の確認
```gherkin
Given ログインページが表示されている
When CSRFトークンなしでログインを試みる
Then リクエストが拒否される
When 有効なCSRFトークンでログインする
Then ログインが成功する
```

### シナリオ3: レート制限の確認
```gherkin
Given 未認証ユーザーとして
When 短時間に10回ログインを試みる
Then レート制限エラーが表示される
When 一定時間待機後に再度ログインする
Then ログインが成功する
```