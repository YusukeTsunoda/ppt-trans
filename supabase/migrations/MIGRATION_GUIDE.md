# Supabaseãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰

## ğŸ“Š ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•´ç†çµæœ

### âœ… æœ€é©åŒ–ã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ

ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ3ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰:

1. **001_initial_schema.sql** - ãƒ¡ã‚¤ãƒ³ã‚¹ã‚­ãƒ¼ãƒï¼ˆçµ±åˆç‰ˆï¼‰
2. **002_create_profiles.sql** - æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
3. **003_storage_bucket.sql** - Storageãƒã‚±ãƒƒãƒˆè¨­å®š

### ğŸ”§ å®Ÿæ–½ã—ãŸä¿®æ­£å†…å®¹

#### 1. ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®çµ±åˆ
- `files`ãƒ†ãƒ¼ãƒ–ãƒ«ã®é‡è¤‡å®šç¾©ã‚’çµ±åˆ
  - æ—§: 001ã¨005ã§åˆ¥ã€…ã«å®šç¾©ï¼ˆã‚«ãƒ©ãƒ æ§‹é€ ã‚‚ç•°ãªã‚‹ï¼‰
  - æ–°: 001ã«çµ±åˆã€å¿…è¦ãªã‚«ãƒ©ãƒ ã‚’ã™ã¹ã¦å«ã‚€

#### 2. filesãƒ†ãƒ¼ãƒ–ãƒ«ã®çµ±åˆã‚«ãƒ©ãƒ æ§‹é€ 
```sql
- id (UUID)
- user_id (UUID) 
- filename (TEXT)
- original_filename (TEXT)
- storage_path (TEXT) -- æ—§file_path
- translated_path (TEXT)
- file_size (INTEGER)
- mime_type (TEXT)
- status (TEXT) -- pending/processing/completed/failed
- source_language (TEXT) -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: auto
- target_language (TEXT) -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ja
- slide_count (INTEGER)
- text_count (INTEGER)
- translation_progress (DECIMAL)
- error_message (TEXT)
- metadata (JSONB)
- created_at/updated_at (TIMESTAMPTZ)
```

#### 3. user_settingsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
- `translation_model`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æœ€æ–°ãƒ¢ãƒ‡ãƒ«ã«æ›´æ–°
- `source_language`ã¨`target_language`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

#### 4. handle_new_useré–¢æ•°ã®æ”¹å–„
- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«è‡ªå‹•çš„ã«:
  - ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šä½œæˆ
  - ä½¿ç”¨åˆ¶é™ã®åˆæœŸåŒ–

#### 5. å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
- `004_storage_bucket.sql` â†’ `003_storage_bucket.sql`ã«ç•ªå·å¤‰æ›´
- `005_create_files_table.sql` â†’ å‰Šé™¤ï¼ˆ001ã«çµ±åˆï¼‰

### ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
```bash
# Supabaseãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒªã‚»ãƒƒãƒˆ
supabase db reset

# ã¾ãŸã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
supabase db reset --local
```

#### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é †ç•ªã«å®Ÿè¡Œ
supabase migration up

# ã¾ãŸã¯å€‹åˆ¥å®Ÿè¡Œ
supabase db push
```

#### 3. ç¢ºèªã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
supabase migration list

# ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ç¢ºèª
supabase db dump --schema-only
```

### âš ï¸ æ³¨æ„äº‹é …

1. **æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨å‰ã«**:
   - å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
   - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ

2. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ**:
   - ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿…è¦
   - ã‚«ãƒ©ãƒ åã®å¤‰æ›´ã«æ³¨æ„ï¼ˆfile_path â†’ storage_pathç­‰ï¼‰

3. **RLSãƒãƒªã‚·ãƒ¼**:
   - ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSãŒæœ‰åŠ¹
   - èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:
```bash
# æœ€å¾Œã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šæ¶ˆã—
supabase migration down

# ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§æˆ»ã™
supabase migration down --to-version 001
```

### ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚å›³

```
auth.users
    â†“
profiles (1:1)
    â”œâ”€â”€ user_settings (1:1)
    â”œâ”€â”€ files (1:N)
    â”‚   â””â”€â”€ translations (1:N)
    â”œâ”€â”€ activity_logs (1:N)
    â””â”€â”€ usage_limits (1:1)

storage.objects (Storage API)
    â””â”€â”€ uploads ãƒã‚±ãƒƒãƒˆ
```

### âœ… çµ±åˆå¾Œã®åˆ©ç‚¹

1. **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ **: 3ã¤ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
2. **ä¸€è²«æ€§**: filesãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ãŒçµ±ä¸€
3. **ä¿å®ˆæ€§**: é‡è¤‡å®šç¾©ãŒãªãç®¡ç†ãŒå®¹æ˜“
4. **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®åŸºç›¤ãŒæ•´å‚™æ¸ˆã¿