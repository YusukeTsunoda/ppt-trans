# Phase 1 & 2 å®Ÿè£…æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ

## æ¤œè¨¼æ—¥æ™‚: 2025-08-16

## ğŸ”´ é‡å¤§ãªå•é¡Œ

### 1. å‹å®šç¾©ã®æ¬ è½
**å•é¡Œ**: Supabaseã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‹å®šç¾©ãŒå­˜åœ¨ã—ãªã„
```typescript
// src/lib/auth/request-scoped-auth.ts:4
import type { Database } from '@/types/database'; // âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
```

**å½±éŸ¿**: 
- å‹å®‰å…¨æ€§ãŒä¿è¨¼ã•ã‚Œãªã„
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯
- IDEã®è£œå®Œæ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„

**æ ¹æœ¬åŸå› **: 
- Supabase CLIã«ã‚ˆã‚‹å‹ç”ŸæˆãŒæœªå®Ÿè¡Œ
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«å‹ç”Ÿæˆã‚¹ãƒ†ãƒƒãƒ—ãŒãªã„

### 2. ãƒ†ã‚¹ãƒˆåŸºç›¤ã®æ¬ å¦‚
**å•é¡Œ**: ãƒ†ã‚¹ãƒˆç’°å¢ƒãŒæ­£ã—ãã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ãªã„
```bash
# ã‚¨ãƒ©ãƒ¼ä¾‹
Cannot find module '@jest/globals'
Cannot find name 'describe'
```

**å½±éŸ¿**:
- ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã§ããªã„
- å“è³ªä¿è¨¼ãƒ—ãƒ­ã‚»ã‚¹ãŒæ©Ÿèƒ½ã—ãªã„
- ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã®ãƒªã‚¹ã‚¯

### 3. ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã®ä¸å®Œå…¨æ€§
**å•é¡Œ**: ãƒ“ãƒ«ãƒ‰IDç®¡ç†ãŒå®Ÿéš›ã®ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã«çµ±åˆã•ã‚Œã¦ã„ãªã„

**ç¾çŠ¶**:
```json
// package.json
"build": "next build"  // ãƒ“ãƒ«ãƒ‰IDç”ŸæˆãŒå«ã¾ã‚Œã¦ã„ãªã„
```

**æœŸå¾…ã•ã‚Œã‚‹å®Ÿè£…**:
```json
"prebuild": "node scripts/build-id-manager.js generate",
"build": "next build",
"postbuild": "node scripts/build-id-manager.js validate"
```

### 4. ç’°å¢ƒå¤‰æ•°ç®¡ç†ã®ä¸å‚™
**å•é¡Œ**: ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ãŒç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿**:
- æ–°ã—ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒæœ‰åŠ¹åŒ–ã•ã‚Œãªã„
- æ®µéšçš„ç§»è¡ŒãŒæ©Ÿèƒ½ã—ãªã„

## ğŸŸ¡ ä¸­ç¨‹åº¦ã®å•é¡Œ

### 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ä¸ä¸€è‡´
**å ´æ‰€**: `src/lib/auth/request-scoped-auth.ts`
```typescript
} catch {
  // Server Componentå†…ã§ã®cookieè¨­å®šã¯ç„¡è¦–
}
```
- ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¦ã„ãªã„
- ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ•ã‚§ã‚¤ãƒ«ãŒæ½œåœ¨çš„ãªå•é¡Œã‚’éš è”½

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®ä¸æ˜ç¢ºã•
**å•é¡Œ**: React `cache()` ã®ä½¿ç”¨ãŒéå‰°
- ã™ã¹ã¦ã®é–¢æ•°ã§cacheã‚’ä½¿ç”¨
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–æˆ¦ç•¥ãŒä¸æ˜ç¢º

### 3. middleware-v2.tsã®æœªä½¿ç”¨
**å•é¡Œ**: æ–°ã—ã„middlewareãŒå®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„
- `src/middleware.ts` ãŒä¾ç„¶ã¨ã—ã¦ä½¿ç”¨ä¸­
- v2ã¸ã®ç§»è¡Œè¨ˆç”»ãŒä¸æ˜ç¢º

## ğŸŸ¢ è‰¯å¥½ãªå®Ÿè£…

### 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã®è¨­è¨ˆ
- ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ­£ã—ãæ’é™¤
- ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã«é©åˆ

### 2. æ®µéšçš„ç§»è¡Œã®ä»•çµ„ã¿
- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹åˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½
- å¾Œæ–¹äº’æ›æ€§ã‚’ç¶­æŒ

### 3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®åŒ…æ‹¬æ€§
- è¤‡æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è©³ç´°ãªç›£è¦–
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å«ã‚€

## ğŸ“Š æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

| é …ç›® | çŠ¶æ…‹ | æ’ä¹…å¯¾ç­– |
|------|------|----------|
| ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹å¯¾å¿œ | âš ï¸ éƒ¨åˆ†çš„ | å‹å®šç¾©ã¨ãƒ†ã‚¹ãƒˆãŒå¿…è¦ |
| ãƒ“ãƒ«ãƒ‰IDç®¡ç† | âŒ æœªçµ±åˆ | CI/CDã¸ã®çµ„ã¿è¾¼ã¿ãŒå¿…è¦ |
| ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤ | âš ï¸ è¨­å®šã®ã¿ | å®Ÿè£…ã¨ã‚¤ãƒ³ãƒ•ãƒ©ãŒå¿…è¦ |
| ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ | âœ… è‰¯å¥½ | å®Œæˆåº¦é«˜ã„ |
| ãƒ†ã‚¹ãƒˆ | âŒ å‹•ä½œä¸å¯ | ç’°å¢ƒæ§‹ç¯‰ãŒå¿…è¦ |
| å‹å®‰å…¨æ€§ | âŒ ä¸å®Œå…¨ | Supabaseå‹ç”ŸæˆãŒå¿…è¦ |

## ğŸš¨ ãã®å ´ã—ã®ãã®å®Ÿè£…ã¨åˆ¤å®šã•ã‚Œã‚‹ç®‡æ‰€

1. **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã ã‘ã§å®Ÿè¡Œç’°å¢ƒãªã—**
   - ãƒ†ã‚¹ãƒˆãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ãŒå®Ÿè¡Œã§ããªã„
   - CI/CDã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„

2. **ãƒ“ãƒ«ãƒ‰IDç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç‹¬ç«‹æ€§**
   - å®Ÿéš›ã®ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã¨çµ±åˆã•ã‚Œã¦ã„ãªã„
   - æ‰‹å‹•å®Ÿè¡ŒãŒå‰æ

3. **å‹å®šç¾©ã®æ¬ å¦‚ã«ã‚ˆã‚‹å‹å®‰å…¨æ€§ã®æ¬ è½**
   - `any`å‹ã®æš—é»™çš„ä½¿ç”¨
   - å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯

4. **ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹åˆ‡ã‚Šæ›¿ãˆã®æœªå®Ÿè£…**
   - ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŒå®Ÿéš›ã«ã¯æ©Ÿèƒ½ã—ãªã„
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ—§å®Ÿè£…ã‚’ä½¿ç”¨

## ğŸ”§ å¿…è¦ãªä¿®æ­£ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³åº§ã«å¿…è¦ãªä¿®æ­£

1. **Supabaseå‹ç”Ÿæˆ**
```bash
npx supabase gen types typescript --project-id [PROJECT_ID] > src/types/database.ts
```

2. **ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
```bash
npm install --save-dev jest @types/jest @jest/globals ts-jest
npm install --save-dev @testing-library/react @testing-library/jest-dom
```

3. **package.jsonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¿½åŠ **
```json
{
  "scripts": {
    "type-check": "tsc --noEmit",
    "test": "jest",
    "test:watch": "jest --watch",
    "prebuild": "npm run type-check && node scripts/build-id-manager.js generate",
    "build": "next build",
    "postbuild": "node scripts/build-id-manager.js validate"
  }
}
```

4. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
```bash
# .env.local
USE_REQUEST_SCOPED_AUTH=true
BUILD_ID_VALIDATION=true
```

5. **middlewareã®åˆ‡ã‚Šæ›¿ãˆ**
```typescript
// next.config.js ã§è¨­å®šã™ã‚‹ã‹ã€middleware.tsã‚’ç›´æ¥ç½®ãæ›ãˆ
```

### ä¸­æœŸçš„ãªæ”¹å–„

1. **CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰**
   - GitHub Actionsã§ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
   - ãƒ“ãƒ«ãƒ‰IDç®¡ç†ã®è‡ªå‹•åŒ–
   - ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å®Ÿè£…

2. **ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã®å®Ÿè£…**
   - Datadogã¾ãŸã¯é¡ä¼¼ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®çµ±åˆ
   - ã‚¨ãƒ©ãƒ¼ç‡ã®ç›£è¦–
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**
   - ç§»è¡Œã‚¬ã‚¤ãƒ‰ã®ä½œæˆ
   - é‹ç”¨æ‰‹é †æ›¸ã®æ•´å‚™

## çµè«–

**ç¾çŠ¶è©•ä¾¡**: ğŸ”´ **ãã®å ´ã—ã®ãã®å®Ÿè£…**

ç†ç”±ï¼š
- å®Ÿéš›ã«å‹•ä½œã—ãªã„éƒ¨åˆ†ãŒå¤šã„
- çµ±åˆãŒä¸å®Œå…¨
- ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å“è³ªä¿è¨¼ãŒãªã„
- å‹å®‰å…¨æ€§ãŒæ¬ å¦‚

**æ’ä¹…å¯¾ç­–ã¸ã®é“ç­‹**:
1. ä¸Šè¨˜ã®å³åº§ã«å¿…è¦ãªä¿®æ­£ã‚’ã™ã¹ã¦å®Ÿæ–½
2. ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œå¯èƒ½ã«ã—ã¦å“è³ªã‚’ä¿è¨¼
3. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ±åˆ
4. æœ¬ç•ªç’°å¢ƒã§ã®æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

ç¾åœ¨ã®å®Ÿè£…ã¯ã€Œè¨­è¨ˆã€ã¯è‰¯ã„ãŒã€Œå®Ÿè£…ã®å®Œæˆåº¦ã€ãŒä½ãã€æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹ã«ã¯å¤šãã®ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚