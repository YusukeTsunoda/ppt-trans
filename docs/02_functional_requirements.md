# PPT Translator App - 機能要件書

## 1. 機能要件概要

本書は、PPT Translator Appの機能要件を定義します。各機能の詳細な仕様、入出力、処理フロー、および制約事項を記載します。

## 2. 機能一覧

### 2.1 機能カテゴリ
1. **認証・認可機能** (AUTH)
2. **ファイル管理機能** (FILE)
3. **翻訳処理機能** (TRANS)
4. **プレビュー・編集機能** (EDIT)
5. **ユーザー管理機能** (USER)
6. **管理者機能** (ADMIN)
7. **通知機能** (NOTIF)
8. **設定機能** (SETTING)

## 3. 認証・認可機能 (AUTH)

### AUTH-001: ユーザー登録
**概要**: 新規ユーザーアカウントの作成

**入力**:
- メールアドレス（必須）
- パスワード（必須、8文字以上）
- 氏名（任意）
- 組織名（任意）

**処理**:
1. 入力値バリデーション
2. メールアドレス重複チェック
3. パスワードハッシュ化
4. アカウント作成
5. 確認メール送信

**出力**:
- 登録成功/失敗メッセージ
- 確認メールリンク

**制約**:
- 1メールアドレスにつき1アカウント
- パスワード複雑性要件適用

### AUTH-002: ログイン
**概要**: ユーザー認証とセッション作成

**入力**:
- メールアドレス
- パスワード

**処理**:
1. 認証情報検証
2. 2要素認証（有効な場合）
3. JWTトークン生成
4. セッション作成
5. ログイン履歴記録

**出力**:
- 認証トークン
- ユーザー情報
- リダイレクト先URL

### AUTH-003: ログアウト
**概要**: セッション終了

**処理**:
1. セッション無効化
2. トークン削除
3. ログアウト記録

### AUTH-004: パスワードリセット
**概要**: パスワード再設定機能

**入力**:
- メールアドレス

**処理**:
1. アカウント存在確認
2. リセットトークン生成
3. リセットリンクメール送信
4. 新パスワード設定
5. 旧セッション無効化

## 4. ファイル管理機能 (FILE)

### FILE-001: ファイルアップロード
**概要**: PPTXファイルのアップロード

**受入基準**:
- [ ] 認証済みユーザーのみアップロード可能
- [ ] ファイル拡張子が.pptx
- [ ] マジックナンバーがPKZip形式
- [ ] ファイルサイズが50MB以下
- [ ] ウイルススキャンパス
- [ ] 使用量制限内

**入力**:
- PPTXファイル（最大50MB）
- メタデータ（任意）

**処理**:
1. ファイル形式検証（マジックナンバー確認）
2. Zip bomb対策（圧縮率チェック）
3. ウイルススキャン
4. Supabase Storageへの保存
5. ジョブキューへの登録
6. メタデータ抽出
   - スライド数
   - ファイルサイズ
   - 作成日時

**出力**:
- ジョブID（UUID）
- ファイル情報
- 処理ステータス（queued/processing/completed/failed）

**制約**:
- 対応形式: .pptx のみ
- 最大サイズ: 50MB
- 同時アップロード数: 5ファイル
- タイムアウト: 30秒（アップロード処理）

### FILE-002: ファイル一覧表示
**概要**: ユーザーのファイル一覧表示

**受入基準**:
- [ ] 認証済みユーザーのみアクセス可
- [ ] ページネーション境界テスト（0件、1件、最大件数）
- [ ] 権限外ファイルが混じらない（RLS適用）
- [ ] ソート/フィルターがSQLインジェクション対策済み

**入力**:
- ページ番号（デフォルト: 1）
- 表示件数（デフォルト: 20、最大: 100）
- ソート条件（created_at desc）
- フィルター条件（status、言語等）

**処理**:
1. Supabase RLSによるアクセス制御
2. ファイルリスト取得（ジョブステータス付き）
3. ページネーション処理
4. ソート・フィルター適用

**出力**:
- ファイルリスト（ジョブステータス付き）
- ページング情報
- 統計情報（総件数、処理中件数等）

### FILE-003: ファイルダウンロード
**概要**: 翻訳済みファイルのダウンロード

**入力**:
- ファイルID
- ダウンロード形式

**処理**:
1. アクセス権限確認
2. ファイル存在確認
3. ダウンロードURL生成
4. ダウンロード履歴記録

**出力**:
- ダウンロードURL（有効期限付き）
- ファイルバイナリ

### FILE-004: ファイル削除
**概要**: アップロードファイルの削除

**入力**:
- ファイルID
- 削除確認フラグ

**処理**:
1. 所有権確認
2. 関連データ削除
3. ストレージから物理削除
4. 削除履歴記録

## 5. 翻訳処理機能 (TRANS)

### TRANS-000: 翻訳メモリ(TM)・用語集(TB)管理【中核機能】
**概要**: 翻訳の一貫性担保とコスト削減のための翻訳資産管理

**機能**:
1. **自動TM/TB構築**
   - ユーザーが翻訳・編集した内容を自動学習
   - プロジェクト/組織単位でのTM/TB管理
   - 類似度スコアリング（あいまい一致）

2. **インポート/エクスポート**
   - TMX形式のインポート/エクスポート
   - CSV/Excel形式での用語集管理
   - 既存翻訳資産の活用

3. **翻訳サジェスト**
   - 過去の翻訳から自動提案（90%以上一致）
   - あいまい一致の提示（70-89%一致）
   - 用語集に基づく一貫性チェック

**処理**:
1. 原文のハッシュ化と保存
2. ベクトル検索による類似文検索
3. スコアリングと優先順位付け
4. リアルタイムサジェスト表示

**制約**:
- TM容量: スタータープラン1万エントリ、プロ10万エントリ
- TB容量: スタータープラン1000語、プロ1万語

### TRANS-001: 翻訳実行（サーバーアクション実装）
**概要**: PPTXファイルの翻訳処理（React 19 Server Actions使用）

**表内テキスト対応**:
- テーブル内のセル単位でテキスト抽出
- セルの結合情報を保持
- 表のヘッダー行を識別して文脈を考慮
- セル内の改行・書式を維持

**入力**:
- ファイルID
- ソース言語（自動検出可）
- ターゲット言語
- 翻訳オプション
  - 翻訳モデル選択（Haiku/Sonnet）
  - 専門用語辞書
  - スタイル設定

**ジョブ処理設計**:
```typescript
interface TranslationJob {
  id: string; // UUID
  status: 'queued' | 'processing' | 'completed' | 'failed';
  progress: number; // 0-100
  createdAt: Date;
  startedAt?: Date;
  completedAt?: Date;
  error?: string;
  retryCount: number;
  result?: TranslationResult;
}
```

**処理フロー**:
1. **ジョブキュー登録**
   - Supabase DBにジョブ作成
   - ステータス: 'queued'
   - 即座にジョブID返却

2. **非同期処理（バックグラウンド）**
   - Pythonコンテナ起動
   - ファイル解析（表内テキスト含む）
   - TM/TB検索（ヒット率計測）
   - Claude API呼び出し（TM未ヒット分のみ）
   - バッチ処理（20テキスト/リクエスト）
   - レート制限（エクスポネンシャルバックオフ）

3. **進捗更新**
   - 10%ごとにDB更新
   - リアルタイム通知（Supabase Realtime）

4. **結果保存**
   - 翻訳結果をDBに保存
   - TM/TBを更新
   - ステータス: 'completed'

**出力**:
- 翻訳済みファイルID
- 処理ステータス
- 翻訳統計情報

**制約**:
- 最大テキスト量: 100,000文字
- 同時処理数: ユーザーあたり3件

### TRANS-002: 翻訳進捗確認
**概要**: 翻訳処理の進捗状況確認

**入力**:
- ジョブID

**処理**:
1. ジョブステータス取得
2. 進捗率計算
3. 推定完了時間算出

**出力**:
- 進捗率（%）
- 現在のステップ
- 推定完了時間
- エラー情報（ある場合）

### TRANS-003: 翻訳キャンセル
**概要**: 実行中の翻訳処理をキャンセル

**入力**:
- ジョブID

**処理**:
1. ジョブ状態確認
2. 処理中断
3. リソース解放
4. ステータス更新

## 6. プレビュー・編集機能 (EDIT)

### EDIT-001: スライドプレビュー（インタラクティブ表示）
**概要**: スライドのプレビュー表示とテキストハイライト機能

**入力**:
- ファイルID
- スライド番号
- 表示サイズ
- ハイライト対象テキストID（オプション）

**処理**:
1. python-pptxによるスライド解析
2. スライド画像生成
3. テキスト位置情報取得
4. レイアウト情報構築
5. ハイライト領域計算

**出力**:
- スライド画像
- テキスト配置情報（座標情報付き）
- 編集可能エリア情報
- ハイライト表示データ

### EDIT-002: テキストペア編集（ツインパネル）
**概要**: 原文と翻訳文の並列表示・編集

**入力**:
- テキストID
- 新しい翻訳テキスト
- フォーマット情報

**処理**:
1. 原文と翻訳文のペア表示
2. リアルタイムテキスト更新
3. レイアウト調整
4. プレビュー再生成
5. 変更履歴保存

**出力**:
- 更新結果
- 新プレビュー画像
- テキストペア情報

### EDIT-003: 一括置換
**概要**: 用語の一括置換

**入力**:
- 検索文字列
- 置換文字列
- 対象範囲

**処理**:
1. 対象テキスト検索
2. 置換処理
3. 影響範囲確認
4. プレビュー更新

### EDIT-004: 変更履歴管理
**概要**: 編集履歴の管理

**機能**:
- 変更履歴表示
- 特定バージョンへの復元
- 差分表示

## 7. ユーザー管理機能 (USER)

### USER-001: プロフィール管理
**概要**: ユーザープロフィール情報の管理

**機能**:
- プロフィール表示
- プロフィール編集
- アバター画像アップロード
- アカウント削除

### USER-002: 使用量管理
**概要**: 使用量の確認と制限管理

**表示情報**:
- 月間翻訳文字数
- ファイルアップロード数
- ストレージ使用量
- 残り使用可能量

### USER-003: 課金管理
**概要**: サブスクリプション管理

**機能**:
- 現在のプラン表示
- プラン変更
- 支払い方法管理
- 請求履歴表示
- 領収書発行

## 8. 管理者機能 (ADMIN)

### ADMIN-001: ユーザー管理
**概要**: システム全体のユーザー管理

**機能**:
- ユーザー一覧表示
- ユーザー検索
- アカウント有効/無効化
- 権限変更
- 使用量制限設定

### ADMIN-002: システム監視
**概要**: システム状態の監視

**監視項目**:
- APIコール数
- エラー率
- 応答時間
- リソース使用率
- 同時接続数

### ADMIN-003: コンテンツ管理
**概要**: 不適切コンテンツの管理

**機能**:
- フラグ付きコンテンツ確認
- コンテンツ削除
- ユーザー警告

### ADMIN-004: 統計レポート
**概要**: 利用統計レポート生成

**レポート内容**:
- 日次/週次/月次統計
- ユーザー増加率
- 人気言語ペア
- エラー分析
- 収益レポート

## 9. 通知機能 (NOTIF)

### NOTIF-001: メール通知
**通知タイプ**:
- アカウント確認
- パスワードリセット
- 翻訳完了
- エラー通知
- プロモーション

### NOTIF-002: アプリ内通知
**通知タイプ**:
- 処理完了
- システムメンテナンス
- 新機能案内
- 使用量警告

### NOTIF-003: 通知設定
**設定項目**:
- 通知ON/OFF
- 通知頻度
- 通知方法選択

## 10. 設定機能 (SETTING)

### SETTING-001: アプリケーション設定
**設定項目**:
- 言語設定
- タイムゾーン
- テーマ（ライト/ダーク）
- 表示設定

### SETTING-002: 翻訳設定
**設定項目**:
- デフォルト言語ペア
- 翻訳品質レベル
- 専門分野選択
- カスタム辞書

### SETTING-003: セキュリティ設定
**設定項目**:
- 2要素認証
- セッションタイムアウト
- IPアドレス制限
- APIキー管理

## 11. データモデルと権限マトリクス

### 主要エンティティ
1. **User**: ユーザー情報
2. **File**: アップロードファイル
3. **TranslationJob**: 翻訳ジョブ（非同期処理）
4. **TranslatedText**: 翻訳済みテキスト
5. **TranslationMemory**: TMエントリ
6. **TermBase**: TBエントリ
7. **Subscription**: サブスクリプション
8. **UsageLog**: 使用量ログ
9. **AuditLog**: 監査ログ

### 権限マトリクス

| 操作/ロール | GUEST | USER | ADMIN | SUPER_ADMIN |
|-------------|-------|------|-------|-------------|
| ファイルアップロード | × | ○ | ○ | ○ |
| ファイル一覧（自分） | × | ○ | ○ | ○ |
| ファイル一覧（全体） | × | × | ○ | ○ |
| 翻訳実行 | × | ○ | ○ | ○ |
| TM/TB編集 | × | ○ | ○ | ○ |
| ユーザー管理 | × | × | ○ | ○ |
| システム設定 | × | × | × | ○ |
| 監査ログ閲覧 | × | × | △ | ○ |

## 12. API仕様

### Server Actions（React 19）
主要な処理はServer Actionsで実装：
- `registerAction()` - ユーザー登録
- `loginAction()` - ログイン
- `uploadFileAction()` - ファイルアップロード
- `getFilesAction()` - ファイル一覧取得
- `translateAction()` - 翻訳実行
- `getTranslationStatusAction()` - 翻訳ステータス確認
- `editTextAction()` - テキスト編集
- `getProfileAction()` - プロフィール取得

### API Routes（必要最小限）
外部連携で必要なエンドポイントのみ実装：
- `POST /api/stripe/webhook` - Stripe決済通知
- `GET /api/auth/callback` - OAuth認証コールバック
- `GET /api/files/{id}/download` - ファイルダウンロード

## 13. 画面遷移

### 主要画面フロー
1. ログイン → ダッシュボード
2. ダッシュボード → ファイルアップロード
3. アップロード完了 → プレビュー画面
4. プレビュー → 編集画面
5. 編集完了 → ダウンロード

## 14. エラー処理とリトライポリシー

### エラーコード体系
| コード | カテゴリ | リトライ | ユーザーメッセージ |
|-------|----------|---------|----------------|
| 1xxx | 認証エラー | 不可 | ログインが必要です |
| 2xxx | バリデーション | 不可 | 入力内容を確認してください |
| 3xxx | 処理エラー | 可（3回） | 一時的な問題が発生しました |
| 4xxx | 外部API | 可（バックオフ） | 翻訳サービスが混雑しています |
| 5xxx | システム | 不可 | システムエラーが発生しました |

### リトライポリシー
```typescript
const retryPolicy = {
  maxAttempts: 3,
  backoff: 'exponential', // 1s, 2s, 4s
  retryableErrors: [3xxx, 4xxx],
  jitter: true // ランダム遅延追加
};
```

---
*ドキュメントバージョン: 1.0*  
*最終更新日: 2025年1月*